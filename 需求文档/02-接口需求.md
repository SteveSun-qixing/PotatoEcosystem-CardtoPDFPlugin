# CardtoPDFPlugin 接口需求

## 接口体系

CardtoPDFPlugin 作为文件转换系统的插件，需要实现两类接口。一类是转换插件的标准接口，用于向文件转换接口模块注册能力、接收转换请求、返回转换结果。另一类是插件系统的通用接口，用于插件的生命周期管理、配置管理、服务注册等。

所有接口的调用都遵循中心路由架构原则，通过薯片微内核进行路由。插件不直接与其他模块通信，而是通过内核的消息传递机制与文件转换接口模块、渲染器模块、资源管理模块等进行交互。

## 转换能力注册接口

插件启动后需要向文件转换接口模块注册自己的转换能力。注册接口声明插件支持的源文件类型和目标文件类型，以及支持的转换选项。

源文件类型声明中，插件声明支持处理 .card 格式的卡片文件。这是薯片生态的标准卡片格式，插件能够解析卡片的元数据、结构信息和内容配置。

目标文件类型声明中，插件声明能够输出 PDF 格式的文档。PDF 是一种标准的文档交换格式，插件生成的 PDF 符合 PDF 规范，可以被各种 PDF 阅读器打开。

转换选项声明中，插件声明支持的所有配置参数。这些参数包括页面设置选项（页面大小、方向、边距）、封面目录选项（是否添加封面、是否生成目录）、输出选项（压缩质量、输出模式）等。接口模块记录这些信息，以便应用层查询插件能力。

## 转换执行接口

转换执行接口是插件的核心接口，用于接收转换请求并执行实际的转换工作。

请求数据包含源文件信息和转换选项。源文件信息可以是卡片文件的路径，插件通过文件系统读取卡片内容。源文件信息也可以是已解析的卡片数据对象，插件直接处理卡片数据。转换选项指定页面设置、封面目录、输出控制等参数，未指定的选项使用默认值。

响应数据包含转换结果和统计信息。转换成功时，响应中包含输出文件的路径（文件输出模式）或 PDF 数据（数据输出模式）。响应还包含转换统计信息，如处理的基础卡片数量、总页数、输出文件大小、转换耗时等。转换失败时，响应中包含错误码和错误描述。

## 进度查询接口

对于耗时较长的转换任务，插件需要支持进度查询。转换执行接口在开始处理时返回一个任务 ID，调用方使用这个任务 ID 查询转换进度。

进度信息包含任务的当前状态（处理中、已完成、已取消、已失败）、总体完成百分比、当前处理阶段的描述、已处理的基础卡片数量、已处理的资源数量等。进度信息实时更新，调用方可以定期查询获取最新状态。

任务完成后，进度查询接口返回最终状态和转换结果。调用方可以在任务完成前的任何时候查询进度，获取当前的处理状态。

## 任务取消接口

任务取消接口允许调用方中止正在进行的转换任务。调用方提供任务 ID，请求取消对应的转换任务。

插件在收到取消请求后，在下一个安全检查点停止处理。安全检查点通常在处理完一个基础卡片之后或处理完一个资源之后。插件不会在处理过程中立即中断，以避免数据不一致或资源泄漏。

取消完成后，插件清理已生成的临时文件和内存数据，返回取消成功的状态。如果任务已经完成或已经失败，取消请求返回相应的状态说明。

## 渲染器调用接口

转换过程中，插件需要调用渲染器获取基础卡片的渲染结果。渲染器调用通过微内核路由到公共基础层的 CardRenderer 模块。

渲染请求包含基础卡片的配置数据和渲染选项。渲染选项指定目标格式为 HTML，以便后续转换为 PDF。渲染选项还可以指定主题、是否加载资源等参数。

渲染响应包含基础卡片的 HTML 内容和相关的 CSS 样式。插件将 HTML 内容转换为 PDF 页面，保持渲染结果的视觉效果。如果渲染失败，响应中包含错误信息，插件根据配置决定是跳过该卡片还是中止整个转换。

## 资源获取接口

转换过程中，插件需要获取卡片引用的资源文件。资源获取通过微内核路由到资源管理模块。

对于内部资源，插件请求从卡片文件中提取指定路径的资源数据。资源管理模块解析卡片文件，返回资源的二进制数据和 MIME 类型。

对于外部资源，插件请求从文件系统或网络获取资源。资源管理模块根据资源路径的类型，从本地文件系统读取或从网络下载资源数据。

资源响应包含资源的二进制数据、MIME 类型、原始尺寸等信息。插件根据这些信息决定如何将资源嵌入 PDF 文档。如果资源获取失败，插件根据配置决定是使用占位图还是中止转换。

## 配置管理接口

插件需要实现配置管理接口，允许调用方获取和修改插件的默认配置。

配置获取接口返回插件当前的默认配置值，包括所有转换选项的默认设置。配置项按照类别组织，包括页面设置类、封面目录类、输出控制类等。

配置更新接口允许修改插件的默认配置。修改后的配置影响后续的转换请求，已经在进行中的转换任务不受影响。配置更新需要验证配置值的有效性，无效的配置值会被拒绝。

配置重置接口将插件配置恢复为出厂默认值。这个接口在用户需要清除所有自定义配置时使用。

## 插件生命周期接口

作为薯片生态的标准插件，CardtoPDFPlugin 需要实现插件生命周期接口。

初始化接口在插件加载时调用。插件在这个阶段获取核心服务的引用，初始化内部状态，但不执行耗时操作。

启动接口在插件准备好提供服务时调用。插件在这个阶段向文件转换接口模块注册转换能力，开始接收转换请求。

停止接口在插件需要暂停服务时调用。插件在这个阶段停止接收新的转换请求，但等待正在进行的任务完成。

销毁接口在插件卸载时调用。插件在这个阶段向文件转换接口模块注销转换能力，释放所有资源，清理临时文件。

## 元数据接口

插件需要提供元数据接口，返回插件的基本信息。元数据包括插件的唯一标识符、名称、版本号、描述、作者、许可证等信息。

元数据还包括插件支持的协议版本范围，表明插件兼容哪些版本的薯片生态协议。文件转换接口模块使用这些信息进行版本兼容性检查。

元数据接口返回的信息用于插件管理、应用市场展示、用户界面显示等场景。
